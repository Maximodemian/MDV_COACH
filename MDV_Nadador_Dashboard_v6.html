
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MDV Swim ¬∑ Nadador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: linear-gradient(90deg,#1e3a8a,#2563eb);
      color: white;
      padding: 0.9rem 1.2rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    header h1 span.logo {
      display:inline-flex;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
    }
    header small {
      font-size: 0.72rem;
      opacity: 0.9;
    }
    main {
      padding: 0.8rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(15,23,42,0.12);
      padding: 0.8rem 0.9rem;
      margin-bottom: 0.9rem;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .card h2 span.dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #2563eb;
    }
    label {
      display: block;
      font-size: 0.78rem;
      margin-top: 0.45rem;
      color: #374151;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.45rem;
      margin-top: 0.15rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      background: #f9fafb;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.2);
      background: white;
    }
    button {
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      margin-top: 0.6rem;
      background: #2563eb;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    button.secondary { background: #6b7280; }
    button.ghost { background: #e5e7eb; color: #111827; }
    button:disabled { opacity: 0.6; cursor: default; }
    button span.icon { font-size: 0.85rem; }
    .msg {
      font-size: 0.75rem;
      margin-top: 0.3rem;
      min-height: 1rem;
    }
    .msg.error { color: #b91c1c; }
    .msg.ok { color: #15803d; }

    .status-panel {
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      color: #312e81;
      padding: 0.45rem 0.65rem;
      border-radius: 10px;
      font-size: 0.78rem;
      margin-bottom: 0.8rem;
      min-height: 1.2rem;
    }
    .status-panel.error { background: #fef2f2; border-color: #fecdd3; color: #991b1b; }
    .status-panel.ok { background: #ecfdf3; border-color: #bbf7d0; color: #14532d; }

    .info-toggle {
      font-size: 0.75rem;
      color: #2563eb;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      cursor: pointer;
      margin-top: 0.3rem;
    }
    .info-body {
      font-size: 0.75rem;
      color: #4b5563;
      margin-top: 0.3rem;
      display: none;
    }

    .legend {
      font-size: 0.72rem;
      color: #6b7280;
      margin-top: 0.4rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .legend span.box {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }

    .marks-list {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0 0;
      max-height: 320px;
      overflow-y: auto;
    }
    .mark-item {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.35rem 0.2rem;
      font-size: 0.8rem;
    }
    .mark-header {
      display: flex;
      justify-content: space-between;
      gap: 0.3rem;
    }
    .mark-main {
      font-weight: 600;
    }
    .tag {
      display: inline-flex;
      font-size: 0.72rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      margin-left: 0.25rem;
    }
    .mark-sub {
      font-size: 0.72rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }
    .mark-footer {
      font-size: 0.72rem;
      margin-top: 0.25rem;
      color: #111827;
    }
    .badge-nivel {
      display: inline-flex;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.72rem;
      align-items: center;
      gap: 0.25rem;
    }
    .badge-AA { background:#1d4ed8; color:white; }
    .badge-A { background:#16a34a; color:white; }
    .badge-AR { background:#eab308; color:#111827; }
    .badge-none { background:#e5e7eb; color:#374151; }
    .brecha-pos { color:#b91c1c; }
    .brecha-neg { color:#15803d; }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.2rem;
    }
    .chip-small {
      font-size: 0.7rem;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      background: #f3f4f6;
      color: #374151;
    }

    .inline-row {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .inline-row > div {
      flex: 1 1 120px;
    }

    .profile-meta {
      margin-top: 0.4rem;
      font-size: 0.78rem;
      color: #4b5563;
    }
    .profile-meta span.badge {
      display: inline-block;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      background: #e5e7eb;
      margin-right: 0.3rem;
    }
  </style>
</head>
<body>
<header>
  <h1>
    <span class="logo">MDV</span>
    Swim ¬∑ Panel del Nadador
  </h1>
  <small>Registr√° tus tiempos y mir√° c√≥mo se comparan con niveles nacionales e internacionales.</small>
</header>
<main>

  <div id="statusPanel" class="status-panel"></div>

  <!-- PERFIL NADADOR -->
  <section class="card">
    <h2><span class="dot"></span> Mi perfil</h2>
    <label>URL Web App (Coach)
      <input id="webapp_url" type="text" placeholder="https://script.google.com/macros/s/XXXX/exec">
    </label>
    <label>Coach ID
      <input id="coach_id" type="text" placeholder="COACH_MDV_001">
    </label>
    <label>Swimmer ID (si ya lo ten√©s)
      <div class="inline-row" style="align-items:flex-end;">
        <div style="flex:1 1 200px;">
          <input id="swimmer_id" type="text" placeholder="se puede generar autom√°tico">
        </div>
        <div>
          <button id="btnCargarPerfil" type="button" onclick="cargarPerfil()">
            <span class="icon">üîÑ</span> Sincronizar perfil
          </button>
        </div>
        <div>
          <button id="btnLimpiar" type="button" class="ghost" onclick="limpiarDatos()">
            <span class="icon">üßπ</span> Limpiar datos
          </button>
        </div>
      </div>
    </label>
    <div id="swimmerNotice" class="msg"></div>
    <label>Nombre y apellido
      <input id="nombre" type="text">
    </label>
    <div class="inline-row">
      <div>
        <label>Fecha de nacimiento
          <input id="fecha_nac" type="date" oninput="actualizarEdadYCategoria()">
        </label>
      </div>
      <div>
        <label>G√©nero
          <select id="genero">
            <option value="F">Femenino</option>
            <option value="M">Masculino</option>
          </select>
        </label>
      </div>
    </div>
    <div class="inline-row">
      <div>
        <label>Altura (cm)
          <input id="altura_cm" type="number">
        </label>
      </div>
      <div>
        <label>Peso (kg)
          <input id="peso_kg" type="number">
        </label>
      </div>
      <div>
        <label>FC reposo (lpm)
          <input id="fc_reposo" type="number">
        </label>
      </div>
    </div>

    <div class="profile-meta" id="profileMeta">
      <!-- aqu√≠ se mostrar√° edad y categor√≠a calculadas -->
    </div>

    <button id="btnGuardarPerfil" onclick="guardarPerfil()">
      <span class="icon">üíæ</span> Guardar perfil
    </button>
    <div id="msgPerfil" class="msg"></div>
  </section>

  <!-- PAR√ÅMETROS DE REFERENCIA -->
  <section class="card">
    <h2><span class="dot"></span> Referencias nacionales e internacionales</h2>
    <div class="legend">
      <span><span class="box" style="background:#1d4ed8;"></span> AA ¬∑ nivel √©lite USA para tu edad</span>
      <span><span class="box" style="background:#16a34a;"></span> A ¬∑ nivel alto USA para tu edad</span>
      <span><span class="box" style="background:#eab308;"></span> AR ¬∑ apto ranking / m√≠nimas nacionales</span>
      <span><span class="box" style="background:#e5e7eb;"></span> Sin corte a√∫n ¬∑ todav√≠a en camino</span>
    </div>
    <div class="info-toggle" onclick="toggleInfo()">
      <span>‚ÑπÔ∏è</span> <span>¬øC√≥mo se leen estos niveles?</span>
    </div>
    <div id="infoBody" class="info-body">
      <p>
        Cada tiempo que carg√°s se compara con tablas de referencia:
      </p>
      <ul style="margin:0.2rem 0 0.1rem 1rem; padding-left:0.9rem;">
        <li><strong>CADDA / m√≠nimas nacionales:</strong> marcan el nivel para entrar a campeonatos argentinos o rankings oficiales.</li>
        <li><strong>USA Swimming (A / AA):</strong> tiempos de desarrollo por edad pensados para el alto rendimiento.</li>
      </ul>
      <p>
        Si tu tiempo ya es mejor que un corte, la brecha se ve en <span style="color:#15803d;font-weight:600;">verde (brecha negativa)</span>.
        Si todav√≠a falta para llegar, se ve en <span style="color:#b91c1c;font-weight:600;">rojo (brecha positiva)</span>.
      </p>
      <p>
        La idea no es compararte con otros, sino usar estas referencias para seguir mejorando tus propias marcas paso a paso.
      </p>
    </div>
  </section>

  <!-- NUEVO REGISTRO -->
  <section class="card">
    <h2><span class="dot"></span> Nuevo registro de marca</h2>
    <div class="inline-row">
      <div>
        <label>Fecha
          <input id="fecha_mark" type="date">
        </label>
      </div>
      <div>
        <label>Lugar / Evento
          <input id="lugar_evento" type="text" placeholder="Torneo Apertura, Parque Roca...">
        </label>
      </div>
    </div>
    <div class="inline-row">
      <div>
        <label>Curso (tipo de pileta)
          <select id="curso">
            <option value="LCM">LCM ¬∑ 50 m (ol√≠mpica)</option>
            <option value="SCM">SCM ¬∑ 25 m (semiol√≠mpica)</option>
            <option value="SCY">SCY ¬∑ 25 yd</option>
          </select>
        </label>
      </div>
      <div>
        <label>Tipo de toma
          <select id="tipo_toma">
            <option value="Competencia">Competencia</option>
            <option value="Test">Test</option>
            <option value="Entrenamiento">Entrenamiento</option>
          </select>
        </label>
      </div>
    </div>
    <div class="inline-row">
      <div>
        <label>Estilo
          <select id="estilo">
            <option value="Freestyle">Libre</option>
            <option value="Backstroke">Espalda</option>
            <option value="Breaststroke">Pecho</option>
            <option value="Butterfly">Mariposa</option>
            <option value="IM">Combinado</option>
          </select>
        </label>
      </div>
      <div>
        <label>Distancia (m)
          <input id="distancia_m" type="number" placeholder="50, 100, 200...">
        </label>
      </div>
      <div>
        <label>Carril
          <input id="carril" type="text">
        </label>
      </div>
    </div>
    <label>Tiempo (m:ss.cc o ss.cc)
      <input id="tiempo_raw" type="text" placeholder="0:34.82 o 34.82">
    </label>

    <button id="btnGuardarMarca" onclick="guardarMarca()">
      <span class="icon">‚è±Ô∏è</span> Guardar marca
    </button>
    <button id="btnActualizarMarcas" class="secondary" onclick="cargarMisMarcas()">
      <span class="icon">üìà</span> Actualizar mis marcas
    </button>
    <div id="msgMark" class="msg"></div>
  </section>

  <!-- MARCAS PERSONALES + LEYENDA POR REGISTRO -->
  <section class="card">
    <h2><span class="dot"></span> Mis marcas y progreso</h2>
    <p style="font-size:0.75rem;color:#6b7280;margin-top:0;">
      Cada registro muestra el color de tu nivel actual y una frase que te orienta cu√°n cerca est√°s del siguiente escal√≥n.
    </p>
    <ul id="marksList" class="marks-list"></ul>
    <div id="msgMarks" class="msg"></div>
  </section>

</main>

<script>
  const STORAGE_KEYS = {
    config: 'mdv_swimmer_config_v3',
    profile: 'mdv_swimmer_profile_v3'
  };

  const state = {
    isLoading: false,
    autoInterval: null,
    currentRequest: null
  };

  function $(...ids) {
    for (const id of ids) {
      const el = document.getElementById(id);
      if (el) return el;
    }
    return null;
  }

  function toggleInfo() {
    const body = $('infoBody');
    if (!body) return;
    body.style.display = body.style.display === 'block' ? 'none' : 'block';
  }

  function setStatus(text, type = '') {
    const panel = $('statusPanel');
    if (!panel) return;
    panel.textContent = text || '';
    panel.className = `status-panel ${type}`.trim();
  }

  function calcularEdad(fecha_nac) {
    if (!fecha_nac) return null;
    const hoy = new Date();
    const nac = new Date(fecha_nac);
    if (isNaN(nac.getTime())) return null;
    let edad = hoy.getFullYear() - nac.getFullYear();
    const m = hoy.getMonth() - nac.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) {
      edad--;
    }
    return edad;
  }

  function toDateInputValue(value) {
    if (!value) return '';
    if (value instanceof Date && !isNaN(value.getTime())) {
      const year = value.getFullYear();
      const month = (value.getMonth() + 1).toString().padStart(2, '0');
      const day = value.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    if (typeof value === 'string') {
      if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
      if (value.includes('T')) return value.slice(0, 10);
      const parsed = new Date(value);
      if (!isNaN(parsed.getTime())) return toDateInputValue(parsed);
    }
    return '';
  }

  function formatErr(err) {
    if (!err) return 'desconocido';
    const str = String(err || '').toLowerCase();
    if (err === 'timeout' || str.includes('timeout') || str.includes('abort')) return 'timeout';
    if (err?.message) return err.message;
    return String(err);
  }

  function determinarCategoriaCADDA(edad) {
    if (edad == null) return null;
    if (edad <= 10) return 'Infantil 1';
    if (edad <= 12) return 'Infantil 2';
    return 'Juvenil / Mayor';
  }

  function actualizarEdadYCategoria() {
    const fecha_nac = $('fecha_nac')?.value;
    const meta = $('profileMeta');
    if (!meta) return;
    const edad = calcularEdad(fecha_nac);
    const categoria = determinarCategoriaCADDA(edad);

    if (!edad) {
      meta.innerHTML = '';
      return;
    }

    meta.innerHTML = `
      <span class="badge">Edad: <strong>${edad}</strong> a√±os</span>
      ${categoria ? `<span class="badge">Categor√≠a estimada: <strong>${categoria}</strong></span>` : ''}
    `;
  }

  function generarSwimmerId(nombre, fecha_nac, coach_id) {
    const baseNombre = (nombre || '').trim().toUpperCase().replace(/\s+/g, '_');
    const a√±o = fecha_nac ? fecha_nac.substring(0, 4) : 'XXXX';
    return `${coach_id || 'COACH'}_${baseNombre}_${a√±o}`;
  }

  function getWebAppUrl_() {
    const input = $('webapp_url', 'webappUrl', 'coachWebAppUrl');
    const v = (input && input.value ? input.value.trim() : '') || '';
    const cfg = loadConfig();
    return (v || cfg.webapp_url || localStorage.getItem('mdv_webapp_url') || '').trim();
  }

  function syncWebAppUrl_() {
    const v = getWebAppUrl_();
    if (v) {
      localStorage.setItem('mdv_webapp_url', v);
      const cfg = loadConfig();
      cfg.webapp_url = v;
      saveConfig(cfg);
    }
    return v;
  }

  function loadConfig() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEYS.config)) || {};
    } catch {
      return {};
    }
  }

  function saveConfig(cfg) {
    localStorage.setItem(STORAGE_KEYS.config, JSON.stringify(cfg || {}));
  }

  function loadProfileFromStorage() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEYS.profile)) || {};
    } catch {
      return {};
    }
  }

  function saveProfile(profile) {
    if (!profile) return;
    const normalized = { ...profile };
    if (normalized.fecha_nac) {
      normalized.fecha_nac = toDateInputValue(normalized.fecha_nac);
    }
    localStorage.setItem(STORAGE_KEYS.profile, JSON.stringify(normalized));
  }

  function fillProfile(profile = {}, { onlyEmpty = false } = {}) {
    const fields = ['nombre', 'fecha_nac', 'genero', 'altura_cm', 'peso_kg', 'fc_reposo'];
    fields.forEach((f) => {
      const el = $(f);
      if (!el) return;
      if (onlyEmpty && el.value) return;
      if (profile[f] != null) {
        el.value = f === 'fecha_nac' ? toDateInputValue(profile[f]) : profile[f];
      }
    });
    if (!onlyEmpty || !$('coach_id')?.value) {
      $('coach_id') && ( $('coach_id').value = profile.coach_id || $('coach_id').value );
    }
    if (!onlyEmpty || !$('swimmer_id')?.value) {
      $('swimmer_id') && ( $('swimmer_id').value = profile.swimmer_id || $('swimmer_id').value );
    }
    actualizarEdadYCategoria();
  }

  function persistConfigFromInputs() {
    const cfg = loadConfig();
    cfg.webapp_url = $('webapp_url')?.value?.trim() || cfg.webapp_url || '';
    cfg.coach_id = $('coach_id')?.value?.trim() || cfg.coach_id || '';
    cfg.swimmer_id = $('swimmer_id')?.value?.trim() || cfg.swimmer_id || '';
    saveConfig(cfg);
  }

  function limpiarDatos() {
    localStorage.removeItem(STORAGE_KEYS.config);
    localStorage.removeItem(STORAGE_KEYS.profile);
    localStorage.removeItem('mdv_webapp_url');
    ['webapp_url', 'coach_id', 'swimmer_id', 'nombre', 'fecha_nac', 'altura_cm', 'peso_kg', 'fc_reposo'].forEach((id) => {
      const el = $(id);
      if (el) el.value = '';
    });
    $('profileMeta') && ( $('profileMeta').innerHTML = '' );
    setStatus('Datos locales limpiados.', '');
  }

  function setLoading(isLoading) {
    state.isLoading = isLoading;
    const btns = ['btnCargarPerfil', 'btnActualizarMarcas', 'btnGuardarMarca', 'btnGuardarPerfil'];
    btns.forEach((id) => {
      const el = $(id);
      if (el) el.disabled = isLoading;
    });
  }

  async function fetchWithTimeout(url, options = {}, timeoutMs = 12000) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort('timeout'), timeoutMs);
    const opts = { ...options, signal: controller.signal };
    try {
      const res = await fetch(url, opts);
      clearTimeout(timer);
      return res;
    } catch (err) {
      clearTimeout(timer);
      throw err;
    }
  }

  function buildGetUrl(action, opts = {}) {
    const url = syncWebAppUrl_();
    const coach_id = $('coach_id')?.value?.trim();
    const swimmer_id = $('swimmer_id')?.value?.trim();
    if (!url) throw new Error('Falta configurar la URL Web App del coach.');
    if (!coach_id) throw new Error('Complet√° Coach ID.');
    const requireSwimmerId = opts.requireSwimmerId !== false;
    if (requireSwimmerId && !swimmer_id) throw new Error('Complet√° Coach ID y Swimmer ID.');

    const params = new URLSearchParams({ action, coach_id });
    if (requireSwimmerId) params.append('swimmer_id', swimmer_id);
    if (opts.params) {
      Object.entries(opts.params).forEach(([k, v]) => {
        if (v != null) params.append(k, v);
      });
    }
    return `${url}?${params.toString()}`;
  }

  async function cargarPerfil() {
    if (state.isLoading) return;
    setLoading(true);
    setStatus('Sincronizando perfil...', '');
    $('msgPerfil') && ( $('msgPerfil').textContent = '' );

    const localProfile = loadProfileFromStorage();
    if (localProfile && Object.keys(localProfile).length) {
      fillProfile(localProfile, { onlyEmpty: false });
      setStatus('Perfil local cargado (sincronizando...)', '');
    }

    try {
      const swimmerFromList = await (async () => {
        try {
          const urlList = buildGetUrl('get_swimmers', { requireSwimmerId: false });
          const res = await fetchWithTimeout(urlList, {}, 12000);
          const data = await res.json();
          const swimmers = data?.swimmers || [];
          const currentId = $('swimmer_id')?.value?.trim();
          if (Array.isArray(swimmers) && currentId) {
            return swimmers.find((s) => s.swimmer_id === currentId) || null;
          }
          return null;
        } catch (err) {
          console.warn('get_swimmers fallback to detailed endpoint:', err);
          return null;
        }
      })();

      if (swimmerFromList) {
        fillProfile(swimmerFromList, { onlyEmpty: false });
        saveProfile({ ...swimmerFromList });
        persistConfigFromInputs();
        setStatus('Perfil sincronizado.', 'ok');
        $('msgPerfil') && ( $('msgPerfil').textContent = '' );
        return;
      }

      const fetchPerfilDetallado = async (retries = 1) => {
        try {
          const url = buildGetUrl('get_swimmer_marks_with_context');
          const res = await fetchWithTimeout(url, {}, 25000);
          const data = await res.json();
          if (data.status !== 'ok' || !data.swimmer) {
            throw new Error(data.message || 'No se recibi√≥ perfil.');
          }
          return data.swimmer;
        } catch (err) {
          if (retries > 0 && formatErr(err) === 'timeout') {
            return fetchPerfilDetallado(retries - 1);
          }
          throw err;
        }
      };

      const swimmer = await fetchPerfilDetallado();
      fillProfile(swimmer, { onlyEmpty: false });
      saveProfile({ ...swimmer });
      persistConfigFromInputs();
      setStatus('Perfil sincronizado y guardado localmente.', 'ok');
      $('msgPerfil') && ( $('msgPerfil').textContent = '' );
    } catch (err) {
      const friendly = formatErr(err);
      if (localProfile && Object.keys(localProfile).length) {
        setStatus(`No se pudo sincronizar (usando datos locales). Motivo: ${friendly}`, '');
      } else {
        setStatus(`Error al sincronizar perfil: ${friendly}`, 'error');
      }
    } finally {
      setLoading(false);
    }
  }

  async function cargarMisMarcas() {
    if (state.isLoading) return;
    const msg = $('msgMarks');
    const list = $('marksList');
    if (list) list.innerHTML = '';
    if (msg) { msg.textContent = ''; msg.className = 'msg'; }

    try {
      const url = buildGetUrl('get_swimmer_marks_with_context');
      setLoading(true);
      setStatus('Cargando marcas...', '');
      state.currentRequest = url;
      const fetchMarks = async (retries = 1) => {
        try {
          const res = await fetchWithTimeout(url, {}, 25000);
          return await res.json();
        } catch (err) {
          if (retries > 0 && formatErr(err) === 'timeout') {
            return fetchMarks(retries - 1);
          }
          throw err;
        }
      };

      const data = await fetchMarks(1);
      if (data.status !== 'ok') {
        throw new Error(data.message || 'No se pudieron cargar las marcas.');
      }

      if (data.swimmer) {
        fillProfile(data.swimmer, { onlyEmpty: true });
        saveProfile({ ...data.swimmer });
        persistConfigFromInputs();
      }

      const marks = (data.marks || []).map(normalizarMarca);
      if (!marks.length) {
        if (msg) { msg.textContent = 'Todav√≠a no hay marcas registradas.'; msg.className = 'msg'; }
        setStatus('Listo.', 'ok');
        return;
      }

      marks.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      marks.forEach((m) => renderMark(m, list));

      if (msg) { msg.textContent = ''; msg.className = 'msg'; }
      setStatus('Listo.', 'ok');
    } catch (err) {
      const friendly = formatErr(err);
      if (msg) { msg.textContent = 'Error al cargar marcas: ' + friendly; msg.className = 'msg error'; }
      setStatus('Error: ' + friendly, 'error');
    } finally {
      setLoading(false);
      state.currentRequest = null;
    }
  }

  function parseTiempo(valor) {
    const num = Number(valor);
    return isNaN(num) ? null : num;
  }

  function normalizarMarca(mark) {
    const m = { ...mark };
    const base = calcularBaseTiempo(m);

    if (m.cadda && m.cadda.tiempo_s != null) {
      if (m.cadda.brecha_s == null && base != null) {
        m.cadda.brecha_s = base - m.cadda.tiempo_s;
      }
      if (m.cadda.brecha_pct == null && m.cadda.brecha_s != null) {
        m.cadda.brecha_pct = (m.cadda.brecha_s / m.cadda.tiempo_s) * 100;
      }
    }

    if (m.usa) {
      if (m.usa.A_s != null && m.usa.A_brecha_s == null && base != null) {
        m.usa.A_brecha_s = base - m.usa.A_s;
      }
      if (m.usa.AA_s != null && m.usa.AA_brecha_s == null && base != null) {
        m.usa.AA_brecha_s = base - m.usa.AA_s;
      }
    }

    m.nivel = determinarNivel(m, base);
    return m;
  }

  function calcularBaseTiempo(m) {
    const equiv = parseTiempo(m.equiv_lcm_s);
    const tiempo = parseTiempo(m.tiempo_s);
    if (equiv != null) return equiv;
    if (tiempo == null) return null;
    if ((m.curso || '').toUpperCase() === 'SCM' && (m.comparacion_curso || '').toUpperCase() === 'LCM') {
      return tiempo * 1.02;
    }
    return tiempo;
  }

  function determinarNivel(m, base) {
    if (m.nivel && m.nivel !== '‚Äî') return m.nivel;
    if (base == null) return '‚Äî';
    if (m.usa && m.usa.AA_s != null && base <= m.usa.AA_s) return 'AA';
    if (m.usa && m.usa.A_s != null && base <= m.usa.A_s) return 'A';
    if (m.cadda && m.cadda.tiempo_s != null && base <= m.cadda.tiempo_s) return m.nivel || 'AR';
    return '‚Äî';
  }

  function renderMark(m, list) {
    if (!list) return;
    const li = document.createElement('li');
    li.className = 'mark-item';

    const prueba = m.prueba || `${m.estilo} ${m.distancia_m}m`;
    const tiempo = m.tiempo_str || m.tiempo_raw || '';
    const cursoLabel = cursoToLabel(m.curso);
    const badge = nivelBadge(m.nivel);
    const textoProgreso = textoMotivacional(m);

    li.innerHTML = `
      <div class="mark-header">
        <div class="mark-main">
          ${prueba}
          <span class="tag">${cursoLabel}</span>
        </div>
        <div class="mark-main">
          ${tiempo}
        </div>
      </div>
      <div class="mark-sub">
        ${formatearFecha(m.fecha)} ¬∑ ${m.tipo_toma || ''} ¬∑ ${m.lugar_evento || ''}
      </div>
      <div class="chips-row">
        ${badge}
        ${brechaChips(m)}
      </div>
      <div class="mark-footer">
        ${textoProgreso}
      </div>
    `;
    list.appendChild(li);
  }

  async function guardarPerfil() {
    const url = syncWebAppUrl_();
    const msg = $('msgPerfil');
    if (!url) {
      if (msg) { msg.textContent = 'Falta configurar la URL Web App del coach.'; msg.className = 'msg error'; }
      return;
    }

    const coach_id = $('coach_id')?.value?.trim();
    let swimmer_id = $('swimmer_id')?.value?.trim();
    const nombre = $('nombre')?.value?.trim();
    const fecha_nac = $('fecha_nac')?.value;
    const genero = $('genero')?.value;
    const altura_cm = Number($('altura_cm')?.value);
    const peso_kg = Number($('peso_kg')?.value);
    const fc_reposo = Number($('fc_reposo')?.value);

    if (!coach_id || !nombre || !fecha_nac) {
      if (msg) { msg.textContent = 'Falta coach, nombre o fecha de nacimiento.'; msg.className = 'msg error'; }
      return;
    }

    if (!swimmer_id) {
      swimmer_id = generarSwimmerId(nombre, fecha_nac, coach_id);
      if ($('swimmer_id')) $('swimmer_id').value = swimmer_id;
    }

    actualizarEdadYCategoria();

    const payload = {
      action: 'register_swimmer',
      coach_id,
      swimmer: { swimmer_id, nombre, fecha_nac, genero, altura_cm, peso_kg, fc_reposo }
    };

    try {
      setLoading(true);
      setStatus('Guardando perfil...', '');
      const res = await fetchWithTimeout(url, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
      });
      const data = await res.json();
      if (data.status === 'ok') {
        if (msg) { msg.textContent = 'Perfil guardado correctamente.'; msg.className = 'msg ok'; }
        saveProfile({ ...payload.swimmer, coach_id });
        persistConfigFromInputs();
        setStatus('Perfil guardado y persistido localmente.', 'ok');
      } else {
        throw new Error(data.message || 'No se pudo guardar.');
      }
    } catch (err) {
      if (msg) { msg.textContent = 'Error: ' + err; msg.className = 'msg error'; }
      setStatus('Error al guardar perfil: ' + err, 'error');
    } finally {
      setLoading(false);
    }
  }

  async function guardarMarca() {
    const url = syncWebAppUrl_();
    const msg = $('msgMark');
    if (!url) {
      if (msg) { msg.textContent = 'Falta configurar la URL Web App del coach.'; msg.className = 'msg error'; }
      return;
    }

    const coach_id = $('coach_id')?.value?.trim();
    const swimmer_id = $('swimmer_id')?.value?.trim();
    const fecha = $('fecha_mark')?.value;
    const lugar = $('lugar_evento')?.value?.trim();
    const curso = $('curso')?.value;
    const tipo_toma = $('tipo_toma')?.value;
    const estilo = $('estilo')?.value;
    const distancia = Number($('distancia_m')?.value);
    const carril = $('carril')?.value?.trim();
    const tiempo_raw = $('tiempo_raw')?.value?.trim();

    if (!coach_id || !swimmer_id || !fecha || !estilo || !distancia || !tiempo_raw) {
      if (msg) { msg.textContent = 'Faltan datos obligatorios (coach, nadador, fecha, estilo, distancia, tiempo).'; msg.className = 'msg error'; }
      return;
    }

    const payload = {
      action: 'add_mark',
      coach_id,
      swimmer_id,
      mark: {
        fecha,
        lugar,
        lugar_evento: lugar,
        curso,
        tipo_toma,
        estilo,
        distancia_m: distancia,
        carril,
        tiempo_raw,
        tiempo_str: tiempo_raw
      }
    };

    try {
      setLoading(true);
      setStatus('Guardando marca...', '');
      const res = await fetchWithTimeout(url, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
      });
      const data = await res.json();
      if (data.status === 'ok') {
        if (msg) { msg.textContent = 'Marca guardada correctamente.'; msg.className = 'msg ok'; }
        if ($('tiempo_raw')) $('tiempo_raw').value = '';
        await cargarMisMarcas();
      } else {
        throw new Error(data.message || 'No se pudo guardar.');
      }
    } catch (err) {
      if (msg) { msg.textContent = 'Error: ' + err; msg.className = 'msg error'; }
      setStatus('Error al guardar marca: ' + err, 'error');
    } finally {
      setLoading(false);
    }
  }

  function cursoToLabel(curso) {
    const c = (curso || '').toUpperCase();
    if (c === 'LCM') return '50 m (ol√≠mpica)';
    if (c === 'SCM') return '25 m (semiol√≠mpica)';
    if (c === 'SCY') return '25 yd';
    return c;
  }

  function nivelBadge(nivel) {
    if (!nivel || nivel === '‚Äî') {
      return '<span class="badge-nivel badge-none">Sin corte todav√≠a</span>';
    }
    if (nivel === 'AA') {
      return '<span class="badge-nivel badge-AA">Nivel AA ¬∑ √©lite para tu edad</span>';
    }
    if (nivel === 'A') {
      return '<span class="badge-nivel badge-A">Nivel A ¬∑ alto rendimiento</span>';
    }
    if (nivel === 'AR') {
      return '<span class="badge-nivel badge-AR">Nivel AR ¬∑ m√≠nima / ranking nacional</span>';
    }
    return `<span class="badge-nivel badge-none">${nivel}</span>`;
  }

  function brechaChips(m) {
    const chips = [];
    if (m.cadda && m.cadda.tiempo_s != null && m.cadda.brecha_s != null) {
      const sign = m.cadda.brecha_s > 0 ? '+' : '';
      const cls = m.cadda.brecha_s > 0 ? 'brecha-pos' : 'brecha-neg';
      chips.push(`<span class="chip-small">CADDA: <span class="${cls}">${sign}${m.cadda.brecha_s.toFixed(2)} s</span></span>`);
    }
    if (m.usa && m.usa.A_s != null && m.usa.A_brecha_s != null) {
      const sign = m.usa.A_brecha_s > 0 ? '+' : '';
      const cls = m.usa.A_brecha_s > 0 ? 'brecha-pos' : 'brecha-neg';
      chips.push(`<span class="chip-small">A: <span class="${cls}">${sign}${m.usa.A_brecha_s.toFixed(2)} s</span></span>`);
    }
    if (m.usa && m.usa.AA_s != null && m.usa.AA_brecha_s != null) {
      const sign = m.usa.AA_brecha_s > 0 ? '+' : '';
      const cls = m.usa.AA_brecha_s > 0 ? 'brecha-pos' : 'brecha-neg';
      chips.push(`<span class="chip-small">AA: <span class="${cls}">${sign}${m.usa.AA_brecha_s.toFixed(2)} s</span></span>`);
    }
    return chips.join(' ');
  }

  function textoMotivacional(m) {
    const nivel = m.nivel || '‚Äî';
    if (nivel === 'AA') {
      return 'Ya est√°s por encima del nivel AA para tu edad. El foco ahora es sostener estas marcas y seguir puliendo detalles t√©cnicos.';
    }
    if (nivel === 'A') {
      if (m.usa && m.usa.AA_brecha_s != null) {
        const falta = m.usa.AA_brecha_s;
        if (falta > 0) {
          return `Est√°s en nivel A. Te faltan aproximadamente ${falta.toFixed(2)} segundos para llegar a AA: objetivo de alto rendimiento internacional.`;
        }
        return 'Est√°s en nivel A y muy cerca (o dentro) de los tiempos AA. Segu√≠ trabajando sobre ritmo de prueba y virajes.';
      }
      return 'Est√°s en nivel A. Es un excelente punto de partida para apuntar a AA.';
    }
    if (nivel === 'AR') {
      if (m.cadda && m.cadda.brecha_s != null) {
        if (m.cadda.brecha_s <= 0) {
          return 'Ya cumpl√≠s m√≠nimas nacionales. El siguiente paso es acercarte a los tiempos A de USA para tu edad.';
        }
        return `Est√°s cerca de la m√≠nima nacional. Te faltan unos ${m.cadda.brecha_s.toFixed(2)} segundos: objetivo alcanzable con continuidad de entrenamiento.`;
      }
      return 'Est√°s en zona de trabajo hacia m√≠nimas nacionales. Cada mejora suma.';
    }
    let objetivo = 'm√≠nimas nacionales';
    if (m.cadda && m.cadda.brecha_s != null && m.cadda.brecha_s > 0 && m.cadda.brecha_s < 3) {
      objetivo = 'tu primera m√≠nima nacional';
    }
    return `Esta marca todav√≠a est√° en camino hacia ${objetivo}. Usala como referencia personal y trat√° de superarla en tu pr√≥ximo intento.`;
  }

  function formatearFecha(f) {
    if (!f) return '';
    const d = new Date(f);
    if (isNaN(d.getTime())) return f;
    const dia = d.getDate().toString().padStart(2, '0');
    const mes = (d.getMonth() + 1).toString().padStart(2, '0');
    const a√±o = d.getFullYear();
    return `${dia}/${mes}/${a√±o}`;
  }

  function initFromStorage() {
    const cfg = loadConfig();
    const legacyUrl = localStorage.getItem('mdv_webapp_url');
    const url = cfg.webapp_url || legacyUrl || '';
    const webappInput = $('webapp_url');
    if (webappInput && url && !webappInput.value) webappInput.value = url;
    const coachInput = $('coach_id');
    if (coachInput && cfg.coach_id && !coachInput.value) coachInput.value = cfg.coach_id;
    const swimmerInput = $('swimmer_id');
    if (swimmerInput && cfg.swimmer_id && !swimmerInput.value) swimmerInput.value = cfg.swimmer_id;

    const profile = loadProfileFromStorage();
    fillProfile(profile, { onlyEmpty: true });
    if (profile.swimmer_id) {
      setStatus('Perfil restaurado desde el dispositivo.', 'ok');
    }
  }

  function attachListeners() {
    ['webapp_url', 'coach_id', 'swimmer_id'].forEach((id) => {
      const el = $(id);
      if (el) {
        el.addEventListener('input', () => {
          persistConfigFromInputs();
          if (id === 'swimmer_id') {
            const notice = $('swimmerNotice');
            if (notice) { notice.textContent = 'Swimmer ID cambi√≥, puedes sincronizar el perfil.'; notice.className = 'msg'; }
          }
        });
      }
    });
    const fechaInput = $('fecha_nac');
    if (fechaInput) fechaInput.addEventListener('change', actualizarEdadYCategoria);
  }

  async function sincronizarMarcasAlArrancar() {
    const cfg = loadConfig();
    const hasBasics = (cfg.webapp_url || $('webapp_url')?.value?.trim())
      && (cfg.coach_id || $('coach_id')?.value?.trim())
      && (cfg.swimmer_id || $('swimmer_id')?.value?.trim());

    if (!hasBasics) return;

    try {
      await cargarMisMarcas();
    } catch (err) {
      console.warn('Auto-sync de marcas fall√≥:', err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initFromStorage();
    attachListeners();
    syncWebAppUrl_();
    sincronizarMarcasAlArrancar();
  });
</script>

</body>
</html>
