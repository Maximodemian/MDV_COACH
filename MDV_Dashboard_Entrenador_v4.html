
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MDV Swim ¬∑ Dashboard Entrenador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: linear-gradient(90deg,#1e3a8a,#2563eb);
      color: white;
      padding: 1rem 1.5rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    header h1 span.logo {
      display:inline-flex;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(255,255,255,0.15);
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
    }
    header small {
      font-size: 0.78rem;
      opacity: 0.9;
    }
    main {
      padding: 1rem;
      max-width: 1300px;
      margin: 0 auto;
    }
    .layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.10);
      padding: 0.9rem 1rem 1rem;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .card h2 span.dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #2563eb;
    }
    label {
      display: block;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      color: #374151;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.45rem;
      margin-top: 0.15rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      background: #f9fafb;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.2);
      background: white;
    }
    button {
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      margin-top: 0.6rem;
      background: #2563eb;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    button.secondary {
      background: #6b7280;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    button span.icon {
      font-size: 0.8rem;
    }
    .msg {
      font-size: 0.75rem;
      margin-top: 0.3rem;
      min-height: 1rem;
    }
    .msg.error { color: #b91c1c; }
    .msg.ok { color: #15803d; }
    .swimmer-list {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0 0;
      max-height: 260px;
      overflow-y: auto;
    }
    .swimmer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0.35rem;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 0.83rem;
      cursor: pointer;
    }
    .swimmer-item:hover {
      background: #eff6ff;
    }
    .swimmer-item span.tag {
      font-size: 0.7rem;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      margin-left: 0.25rem;
    }
    .swimmer-item.active {
      background: #dbeafe;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }
    .header-row h2 {
      border: none;
      padding-bottom: 0;
    }
    .meta {
      font-size: 0.78rem;
      color: #4b5563;
      text-align: right;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      font-size: 0.72rem;
      padding: 0.08rem 0.5rem;
      border-radius: 999px;
      line-height: 1.1;
      white-space: nowrap;
    }
    .legend {
      font-size: 0.72rem;
      color: #6b7280;
      margin-top: 0.3rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .legend span.box {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      margin-top: 0.3rem;
      margin-bottom: 0.3rem;
      font-size: 0.78rem;
    }
    .filters-row > div {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .filters-row label {
      margin-top: 0;
      font-size: 0.72rem;
      color: #6b7280;
    }
    .filters-row select, .filters-row input[type="checkbox"] {
      width: auto;
    }
    .filters-row .inline {
      flex-direction: row;
      align-items: center;
      gap: 0.3rem;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.2rem;
      font-size: 0.75rem;
    }
    .summary-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      background: #f3f4f6;
      color: #374151;
    }

    .table-wrapper {
      max-height: 380px;
      overflow: auto;
      margin-top: 0.4rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.3rem 0.4rem;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    th {
      background: #eff6ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      line-height: 1.1;
      white-space: nowrap;
    }
    .chip-AA { background: #1d4ed8; color: white; }
    .chip-A { background: #16a34a; color: white; }
    .chip-AR { background: #eab308; color: #111827; }
    .chip-none { background: #e5e7eb; color: #374151; }

    .brecha-pos { color: #b91c1c; }  /* le falta */
    .brecha-neg { color: #15803d; }  /* ya super√≥ el corte */

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      font-size: 0.72rem;
      background: #e5e7eb;
      color: #374151;
      white-space: nowrap;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .export-row {
      margin-top: 0.4rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .export-row button {
      background: #0f766e;
    }
    .export-row button.secondary {
      background: #6b7280;
    }
  
    /* --- Mejoras UI v4 --- */
    .last-updated{font-size:0.75rem;color:#6b7280;margin-top:0.2rem;}
    .hint{font-size:0.78rem;color:#6b7280;margin-top:0.25rem;}
    .legend span{ display:inline-flex; align-items:center; gap:.35rem; line-height:1.2; }
    .box{ flex:0 0 auto; }
    .chip, .pill, .summary-pill{ line-height:1.25; }
    .chip{ padding:0.18rem 0.65rem; font-weight:600; }
    .table-wrapper table td.time-cell{ white-space:nowrap; line-height:1.15; }
    .time-sub-inline{ font-size:0.72rem; color:#6b7280; font-weight:500; margin-left:6px; }
    .time-main{ font-weight:700; }
    .time-sub{ font-size:0.72rem; color:#6b7280; margin-top:2px; }
    td, th { letter-spacing: 0.01em; }

  </style>
</head>
<body>
<header>
  <h1>
    <span class="logo">MDV</span>
    Swim ¬∑ Dashboard Entrenador
  </h1>
  <small>Exploraci√≥n de nadadores, marcas y proyecci√≥n vs CADDA / USA Swimming</small>
</header>
<main>
  <div class="layout">
    <!-- LADO IZQUIERDO: Configuraci√≥n + Nadadores -->
    <section class="card">
      <h2><span class="dot"></span> Conexi√≥n</h2>
      <label>URL Web App (Apps Script)
        <input id="web_app_url" type="text" placeholder="https://script.google.com/macros/s/XXXXX/exec">
      </label>
      <label>Coach ID
        <input id="coach_id" type="text" placeholder="COACH_MDV_001">
      </label>
      <label>Spreadsheet ID (planilla del coach)
        <input id="spreadsheet_id" type="text" placeholder="ID de Google Sheet">
      </label>
      <label class="inline">
        <input type="checkbox" id="chkAutoRefresh" checked>
        Auto-actualizar (cada 20 s)
      </label>
      <button id="btnCargarSwimmers" onclick="cargarNadadores()">
        <span class="icon">üîÑ</span> Cargar / Actualizar nadadores
      </button>
      <div class="hint">Lee/actualiza desde la planilla del coach. No borra informaci√≥n.</div>
      <div id="lastUpdated" class="last-updated"></div>
      <div id="msgConfig" class="msg"></div>

      <h2><span class="dot"></span> Nadadores</h2>
      <ul id="swimmerList" class="swimmer-list"></ul>
      <div class="msg" style="font-size:0.72rem;color:#6b7280;">
        Tip: pedile a tus nadadores que usen la app MDV Nadador para ir cargando sus tiempos, y ac√° ves la foto grande.
      </div>
    </section>

    <!-- LADO DERECHO: Informe -->
    <section class="card">
      <div class="header-row">
        <h2><span class="dot"></span> Informe de proyecci√≥n</h2>
        <div class="meta" id="metaSwimmer"></div>
      </div>
      <div class="legend">
        <span>
          <span class="box" style="background:#1d4ed8;"></span> AA (√©lite USA)
        </span>
        <span>
          <span class="box" style="background:#16a34a;"></span> A (nivel alto USA)
        </span>
        <span>
          <span class="box" style="background:#eab308;"></span> AR (apto ranking nacional)
        </span>
        <span>
          <span class="box" style="background:#e5e7eb;"></span> Sin corte a√∫n
        </span>
        <span>
          <span class="box" style="background:#15803d;"></span> Brecha negativa (ya supera el corte)
        </span>
        <span>
          <span class="box" style="background:#b91c1c;"></span> Brecha positiva (lo que falta)
        </span>
      </div>
      <div id="msgReport" class="msg"></div>

      <div class="filters-row">
        <div>
          <label for="filtroEstilo">Filtrar por estilo</label>
          <select id="filtroEstilo" onchange="renderTabla()">
            <option value="todos">Todos</option>
          </select>
        </div>
        <div>
          <label for="filtroNivel">Filtrar por nivel</label>
          <select id="filtroNivel" onchange="renderTabla()">
            <option value="todos">Todos</option>
            <option value="AA">Solo AA</option>
            <option value="A">Solo A</option>
            <option value="AR">Solo AR</option>
            <option value="sin">Sin corte</option>
          </select>
        </div>
        <div class="inline">
          <input type="checkbox" id="chkSoloConUSA" onchange="renderTabla()">
          <label for="chkSoloConUSA">Solo pruebas con est√°ndar USA cargado</label>
        </div>
      </div>

      <div class="summary-row" id="summaryRow"></div>

      <div class="table-wrapper" id="tableWrapper"></div>

      <div class="export-row">
        <button onclick="exportarCSV()">
          <span class="icon">‚¨áÔ∏è</span> Exportar CSV
        </button>
        <!-- Bot√≥n a futuro para PDF (requiere backend) -->
        <!-- <button class="secondary"><span class="icon">üìÑ</span> Exportar PDF</button> -->
      </div>
    </section>
  </div>
</main>

<script>
    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

  let currentEventos = [];
  let currentSwimmerMeta = null;

  // --- Persistencia local (para no reingresar datos cada vez) ---
  const LS_KEY = 'MDV_COACH_DASH_V1';
  const AUTO_REFRESH_MS = 20000;
  let selectedSwimmerId = null;
  let autoRefreshTimer = null;

  function getCfg() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch { return {}; }
  }
  function setCfg(patch) {
    const next = { ...getCfg(), ...patch };
    localStorage.setItem(LS_KEY, JSON.stringify(next));
    return next;
  }
  function saveCfgFromFields() {
    const webAppUrl = document.getElementById('web_app_url').value.trim();
    const coachId = document.getElementById('coach_id').value.trim();
    const spreadsheetId = document.getElementById('spreadsheet_id').value.trim();
    const autoRefresh = !!document.getElementById('chkAutoRefresh')?.checked;
    setCfg({ webAppUrl, coachId, spreadsheetId, autoRefresh, selectedSwimmerId });
  }
  function restoreCfgToFields() {
    const cfg = getCfg();
    if (cfg.webAppUrl) document.getElementById('web_app_url').value = cfg.webAppUrl;
    if (cfg.coachId) document.getElementById('coach_id').value = cfg.coachId;
    if (cfg.spreadsheetId) document.getElementById('spreadsheet_id').value = cfg.spreadsheetId;
    if (typeof cfg.autoRefresh === 'boolean' && document.getElementById('chkAutoRefresh')) {
      document.getElementById('chkAutoRefresh').checked = cfg.autoRefresh;
    }
    if (cfg.selectedSwimmerId) selectedSwimmerId = cfg.selectedSwimmerId;
  }
  function stopAutoRefresh() {
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = null;
  }
  function startAutoRefresh() {
    stopAutoRefresh();
    const cfg = getCfg();
    if (!cfg.autoRefresh) return;
    autoRefreshTimer = setInterval(() => {
      const c = getCfg();
      if (!c.webAppUrl || !c.coachId) return;
      cargarNadadores({ silent: true, keepSelection: true });
    }, AUTO_REFRESH_MS);
  }
  function setLastUpdated(ts = new Date()) {
    const el = document.getElementById('lastUpdated');
    if (!el) return;
    const hh = String(ts.getHours()).padStart(2,'0');
    const mm = String(ts.getMinutes()).padStart(2,'0');
    const ss = String(ts.getSeconds()).padStart(2,'0');
    el.textContent = `√öltima actualizaci√≥n: ${hh}:${mm}:${ss}`;
  }


  async function cargarNadadores(opts = {}) {
    const url = document.getElementById('web_app_url').value.trim();
    const coachId = document.getElementById('coach_id').value.trim();
    const sheetId = document.getElementById('spreadsheet_id').value.trim();
    const silent = !!opts.silent;
    const keepSelection = !!opts.keepSelection;
    const msg = document.getElementById('msgConfig');
    const list = document.getElementById('swimmerList');
    if (!silent) {
      list.innerHTML = '';
      document.getElementById('metaSwimmer').innerText = '';
      document.getElementById('tableWrapper').innerHTML = '';
      document.getElementById('msgReport').innerText = '';
      document.getElementById('summaryRow').innerHTML = '';
    } else {
      // En modo silencioso, solo refrescamos lista y/o el informe seleccionado.
      list.innerHTML = '';
    }

    if (!url || !coachId) {
      if (!silent) {
        msg.textContent = 'Falta URL del Web App o Coach ID.';
        msg.className = 'msg error';
      }
      return;
    }

    if (!silent) {
      msg.textContent = 'Cargando nadadores...';
      msg.className = 'msg';
    }

    try {
      saveCfgFromFields();
      let fullUrl = url + '?action=list_swimmers&coach_id=' + encodeURIComponent(coachId);
      if (sheetId) fullUrl += '&spreadsheet_id=' + encodeURIComponent(sheetId);
      const prevSel = keepSelection ? (selectedSwimmerId || getCfg().selectedSwimmerId) : null;
      let selectedSwimmerObj = null;
      const res = await fetch(fullUrl);
      const data = await res.json();
      if (data.status !== 'ok') {
        msg.textContent = 'Error al cargar nadadores: ' + (data.message || '');
        msg.className = 'msg error';
        return;
      }
      const swimmers = data.swimmers || [];
      if (swimmers.length === 0) {
        msg.textContent = 'No se encontraron nadadores para este coach.';
        msg.className = 'msg';
        return;
      }

      swimmers.forEach(sw => {
        const li = document.createElement('li');
        li.className = 'swimmer-item';
        li.dataset.swimmerId = sw.swimmer_id;
        if (prevSel && sw.swimmer_id === prevSel) {
          li.classList.add('active');
          selectedSwimmerObj = sw;
        }
        li.innerHTML = `
          <div>
            <strong>${sw.nombre}</strong><br>
            <span style="font-size:0.72rem;color:#6b7280;">ID: ${sw.swimmer_id}</span>
          </div>
          <div>
            <span class="tag">${sw.edad || '?'} a√±os</span>
            <span class="tag">${sw.genero || ''}</span>
          </div>
        `;
        li.addEventListener('click', () => seleccionarNadador(li, sw));
        list.appendChild(li);
      });

      if (!silent) {
        msg.textContent = 'Nadadores cargados.';
        msg.className = 'msg ok';
      }
      setLastUpdated(new Date());
      startAutoRefresh();
      if (selectedSwimmerObj) {
        // re-cargar informe del nadador previamente seleccionado
        setMetaSwimmer(selectedSwimmerObj);
        await cargarInforme(selectedSwimmerObj.swimmer_id);
      }

    } catch (err) {
      msg.textContent = 'Error de red: ' + err;
      msg.className = 'msg error';
    }
  }

  function limpiarSeleccionLista() {
    const items = document.querySelectorAll('.swimmer-item');
    items.forEach(it => it.classList.remove('active'));
  }

  function setMetaSwimmer(swimmer){
    const meta = document.getElementById('metaSwimmer');
    meta.innerHTML = `
      <span>${swimmer.nombre}</span>
      <span class="badge">${swimmer.edad || '?'} a√±os</span>
      <span class="badge">${swimmer.genero || ''}</span>
    `;
  }

  async function seleccionarNadador(li, swimmer) {
    limpiarSeleccionLista();
    li.classList.add('active');
    selectedSwimmerId = swimmer.swimmer_id;
    saveCfgFromFields();
    setMetaSwimmer(swimmer);
    await cargarInforme(swimmer.swimmer_id);
  }

  async function cargarInforme(swimmerId) {
    const url = document.getElementById('web_app_url').value.trim();
    const coachId = document.getElementById('coach_id').value.trim();
    const sheetId = document.getElementById('spreadsheet_id').value.trim();
    const msgReport = document.getElementById('msgReport');
    const tableWrapper = document.getElementById('tableWrapper');
    const summaryRow = document.getElementById('summaryRow');

    tableWrapper.innerHTML = '';
    summaryRow.innerHTML = '';
    msgReport.textContent = '';

    if (!url || !coachId) {
      msgReport.textContent = 'Falta Web App URL o Coach ID.';
      msgReport.className = 'msg error';
      return;
    }

    msgReport.textContent = 'Generando informe...';
    msgReport.className = 'msg';

    try {
      let fullUrl = url
        + '?action=get_projection_report'
        + '&coach_id=' + encodeURIComponent(coachId)
        + '&swimmer_id=' + encodeURIComponent(swimmerId);

      if (sheetId) {
        fullUrl += '&spreadsheet_id=' + encodeURIComponent(sheetId);
      }

      const res = await fetch(fullUrl);
      const data = await res.json();
      if (data.status !== 'ok') {
        msgReport.textContent = 'Error al generar informe: ' + (data.message || '');
        msgReport.className = 'msg error';
        return;
      }

      const report = data.report;
      const eventos = report.eventos || [];
      currentEventos = eventos;
      currentSwimmerMeta = report.swimmer || null;

      if (eventos.length === 0) {
        msgReport.textContent = 'No hay eventos registrados para este nadador.';
        msgReport.className = 'msg';
        return;
      }

      // Poblar filtros de estilo din√°micamente
      poblarFiltroEstilo(eventos);
      renderTabla();
      renderResumen();

      msgReport.textContent = '';
      msgReport.className = 'msg';

    } catch (err) {
      msgReport.textContent = 'Error de red: ' + err;
      msgReport.className = 'msg error';
    }
  }

  function poblarFiltroEstilo(eventos) {
    const select = document.getElementById('filtroEstilo');
    const estilosSet = new Set();
    eventos.forEach(ev => estilosSet.add(ev.estilo));
    const estilos = Array.from(estilosSet).sort();
    select.innerHTML = '<option value="todos">Todos</option>';
    estilos.forEach(est => {
      const opt = document.createElement('option');
      opt.value = est;
      opt.textContent = est;
      select.appendChild(opt);
    });
  }

  function renderResumen() {
    const summaryRow = document.getElementById('summaryRow');
    const eventos = currentEventos || [];
    let total = eventos.length;
    let cAA = 0, cA = 0, cAR = 0, cNone = 0;

    eventos.forEach(ev => {
      if (ev.nivel === 'AA') cAA++;
      else if (ev.nivel === 'A') cA++;
      else if (ev.nivel === 'AR') cAR++;
      else cNone++;
    });

    summaryRow.innerHTML = `
      <span class="summary-pill">Pruebas analizadas: <strong>${total}</strong></span>
      <span class="summary-pill">AA: <strong>${cAA}</strong></span>
      <span class="summary-pill">A: <strong>${cA}</strong></span>
      <span class="summary-pill">AR: <strong>${cAR}</strong></span>
      <span class="summary-pill">Sin corte: <strong>${cNone}</strong></span>
    `;
  }

  function renderTabla() {
    const tableWrapper = document.getElementById('tableWrapper');
    const eventos = currentEventos || [];
    if (eventos.length === 0) {
      tableWrapper.innerHTML = '';
      return;
    }

    const filtroEstilo = document.getElementById('filtroEstilo').value;
    const filtroNivel = document.getElementById('filtroNivel').value;
    const soloConUSA = document.getElementById('chkSoloConUSA').checked;

    let filtrados = eventos.filter(ev => {
      if (filtroEstilo !== 'todos' && ev.estilo !== filtroEstilo) return false;
      if (filtroNivel === 'AA' && ev.nivel !== 'AA') return false;
      if (filtroNivel === 'A' && ev.nivel !== 'A') return false;
      if (filtroNivel === 'AR' && ev.nivel !== 'AR') return false;
      if (filtroNivel === 'sin' && (ev.nivel === 'AA' || ev.nivel === 'A' || ev.nivel === 'AR')) return false;
      if (soloConUSA) {
        const usa = ev.usa || {};
        if (usa.A_s == null && usa.AA_s == null) return false;
      }
      return true;
    });

    // Orden simple: por distancia asc, luego por estilo
    filtrados.sort((a,b) => {
      if (a.distancia_m !== b.distancia_m) return a.distancia_m - b.distancia_m;
      if (a.estilo < b.estilo) return -1;
      if (a.estilo > b.estilo) return 1;
      return 0;
    });

    let html = '<table>';
    html += `
      <thead>
        <tr>
          <th>Prueba</th>
          <th>Mejor marca<br>(LCM)</th>
          <th>Origen</th>
          <th>CADDA m√≠n.</th>
          <th>Œî CADDA<br>(s / %)</th>
          <th>USA A</th>
          <th>Œî A<br>(s / %)</th>
          <th>USA AA</th>
          <th>Œî AA<br>(s / %)</th>
          <th>Nivel</th>
        </tr>
      </thead>
      <tbody>
    `;

    filtrados.forEach(ev => {
      const prueba = ev.prueba || (ev.estilo + ' ' + ev.distancia_m + 'm');
      const hasEquiv = !!(ev.equiv_lcm_str && ev.comparacion_curso === 'LCM');
      const marcaStr = hasEquiv ? (ev.equiv_lcm_str || '') : (ev.mejor_tiempo_str || '');
      const subStr = hasEquiv ? `${(ev.mejor_tiempo_str||'')} ${(ev.curso||'')}`.trim() : '';
      const marcaHTML = subStr ? `<div class="time-main">${marcaStr}<span class="time-sub-inline">(${subStr})</span></div>` : `<div class="time-main">${marcaStr}</div>`;
      const origen = ev.origen || ev.origen_marca || '';
      const caddaStr = ev.cadda && ev.cadda.tiempo_str ? ev.cadda.tiempo_str : '';

      const bC_s = ev.cadda && ev.cadda.brecha_s;
      const bC_pct = ev.cadda && ev.cadda.brecha_pct;
      const caddaBrechaHTML = formatBrecha(bC_s, bC_pct);

      const usaA = ev.usa ? ev.usa.A_str : '';
      const bA_s = ev.usa ? ev.usa.A_brecha_s : null;
      const bA_pct = ev.usa ? ev.usa.A_brecha_pct : null;
      const usaABrechaHTML = formatBrecha(bA_s, bA_pct);

      const usaAA = ev.usa ? ev.usa.AA_str : '';
      const bAA_s = ev.usa ? ev.usa.AA_brecha_s : null;
      const bAA_pct = ev.usa ? ev.usa.AA_brecha_pct : null;
      const usaAABrechaHTML = formatBrecha(bAA_s, bAA_pct);

      const nivelChip = formatNivelChip(ev.nivel);

      html += `
        <tr>
          <td>${prueba}</td>
          <td class="time-cell">${marcaHTML}</td>
          <td><span class="pill" title="${escapeHtml(origen || '‚Äî')}">${origen || '‚Äî'}</span></td>
          <td>${caddaStr}</td>
          <td>${caddaBrechaHTML}</td>
          <td>${usaA}</td>
          <td>${usaABrechaHTML}</td>
          <td>${usaAA}</td>
          <td>${usaAABrechaHTML}</td>
          <td>${nivelChip}</td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    tableWrapper.innerHTML = html;
  }

  function formatBrecha(diff_s, diff_pct) {
    if (diff_s == null || isNaN(diff_s)) return '';
    const cls = diff_s <= 0 ? 'brecha-neg' : 'brecha-pos';
    const sign = diff_s > 0 ? '+' : ''; // mostrar + cuando falta
    const pctSign = diff_pct > 0 ? '+' : '';
    return `<span class="${cls}">${sign}${diff_s.toFixed(2)} s<br>${pctSign}${diff_pct.toFixed(2)}%</span>`;
  }

  function formatNivelChip(nivel) {
    if (!nivel || nivel === '‚Äî') {
      return '<span class="chip chip-none">‚Äî</span>';
    }
    if (nivel === 'AA') {
      return '<span class="chip chip-AA">AA</span>';
    }
    if (nivel === 'A') {
      return '<span class="chip chip-A">A</span>';
    }
    if (nivel === 'AR') {
      return '<span class="chip chip-AR">AR</span>';
    }
    return `<span class="chip chip-none">${nivel}</span>`;
  }

  function exportarCSV() {
    const eventos = currentEventos || [];
    if (eventos.length === 0) {
      alert('No hay datos para exportar.');
      return;
    }

    const header = [
      'Prueba',
      'MejorMarca_s',
      'MejorMarca_str',
      'Origen',
      'CADDA_s',
      'CADDA_str',
      'BrechaCADDA_s',
      'BrechaCADDA_%',
      'USA_A_s',
      'USA_A_str',
      'BrechaA_s',
      'BrechaA_%',
      'USA_AA_s',
      'USA_AA_str',
      'BrechaAA_s',
      'BrechaAA_%',
      'Nivel'
    ];

    const rows = eventos.map(ev => {
      return [
        ev.prueba || (ev.estilo + ' ' + ev.distancia_m + 'm'),
        ev.mejor_tiempo_s ?? '',
        ev.mejor_tiempo_str ?? '',
        (ev.origen ?? ev.origen_marca ?? ''),
        ev.cadda?.tiempo_s ?? '',
        ev.cadda?.tiempo_str ?? '',
        ev.cadda?.brecha_s ?? '',
        ev.cadda?.brecha_pct ?? '',
        ev.usa?.A_s ?? '',
        ev.usa?.A_str ?? '',
        ev.usa?.A_brecha_s ?? '',
        ev.usa?.A_brecha_pct ?? '',
        ev.usa?.AA_s ?? '',
        ev.usa?.AA_str ?? '',
        ev.usa?.AA_brecha_s ?? '',
        ev.usa?.AA_brecha_pct ?? '',
        ev.nivel ?? ''
      ];
    });

    let csvContent = header.join(',') + '\n';
    rows.forEach(r => {
      csvContent += r.map(v => {
        const s = String(v);
        if (s.includes(',') || s.includes('"')) {
          return '"' + s.replace(/"/g,'""') + '"';
        }
        return s;
      }).join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const nombre = currentSwimmerMeta ? currentSwimmerMeta.nombre.replace(/\s+/g,'_') : 'nadador';
    a.href = url;
    a.download = `MDV_SWIM_Report_${nombre}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // --- Init ---
  (function init() {
    restoreCfgToFields();
    // guardar cambios en campos
    ['web_app_url','coach_id','spreadsheet_id'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', saveCfgFromFields);
      if (el) el.addEventListener('blur', saveCfgFromFields);
    });
    const chk = document.getElementById('chkAutoRefresh');
    if (chk) chk.addEventListener('change', () => { saveCfgFromFields(); startAutoRefresh(); });

    // Si ya hay datos guardados, cargamos en autom√°tico.
    const cfg = getCfg();
    if (cfg.webAppUrl && cfg.coachId) {
      cargarNadadores({ silent: true, keepSelection: true });
    }
    startAutoRefresh();
    setLastUpdated();
  })();
</script>

</body>
</html>
