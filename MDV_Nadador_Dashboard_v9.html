<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MDV Swim Â· Nadador v9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin:0; padding:0; background:#f9fafb; color:#111827; }
    header { background:linear-gradient(90deg,#0f172a,#2563eb); color:white; padding:0.9rem 1.2rem; }
    header h1 { margin:0; font-size:1.2rem; display:flex; align-items:center; gap:0.45rem; }
    header h1 .logo { width:24px; height:24px; border-radius:999px; background:rgba(255,255,255,0.18); display:inline-flex; align-items:center; justify-content:center; font-weight:700; }
    main { max-width:900px; margin:0 auto; padding:1rem; }
    .card { background:white; border-radius:12px; padding:0.85rem 1rem; margin-bottom:0.9rem; box-shadow:0 4px 12px rgba(15,23,42,0.12); }
    .card h2 { margin-top:0; display:flex; gap:0.4rem; align-items:center; font-size:1rem; border-bottom:1px solid #e5e7eb; padding-bottom:0.35rem; }
    .dot { width:9px; height:9px; background:#2563eb; border-radius:999px; display:inline-flex; }
    label { display:block; font-size:0.82rem; color:#374151; margin-top:0.45rem; }
    input, select { width:100%; box-sizing:border-box; padding:0.38rem 0.45rem; border:1px solid #d1d5db; border-radius:6px; background:#f3f4f6; font-size:0.85rem; }
    input:focus, select:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,.2); background:white; }
    button { border:none; border-radius:10px; padding:0.45rem 0.85rem; background:#2563eb; color:white; cursor:pointer; display:inline-flex; gap:0.35rem; align-items:center; font-size:0.85rem; }
    button.secondary { background:#6b7280; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .msg { font-size:0.8rem; min-height:1rem; margin-top:0.3rem; }
    .msg.error { color:#b91c1c; }
    .msg.ok { color:#15803d; }
    .summary { display:flex; gap:0.45rem; flex-wrap:wrap; font-size:0.82rem; margin-top:0.35rem; }
    .pill { background:#eef2ff; color:#1e3a8a; padding:0.15rem 0.6rem; border-radius:999px; }
    table { width:100%; border-collapse:collapse; font-size:0.82rem; }
    th, td { border-bottom:1px solid #e5e7eb; padding:0.35rem 0.45rem; text-align:center; white-space:nowrap; }
    th { background:#eff6ff; position:sticky; top:0; z-index:2; }
    .table-wrap { border:1px solid #e5e7eb; border-radius:10px; overflow:auto; max-height:360px; margin-top:0.4rem; }
    .inline { display:flex; gap:0.35rem; align-items:center; }
  </style>
</head>
<body>
<header>
  <h1><span class="logo">MDV</span>Swim Â· Nadador v9</h1>
  <small style="opacity:0.9;">Consulta tus marcas, verifica permisos y carga nuevos tiempos</small>
</header>
<main>
  <section class="card">
    <h2><span class="dot"></span> ConexiÃ³n</h2>
    <label>URL Web App
      <input id="webApp" type="url" placeholder="https://script.google.com/macros/s/.../exec">
    </label>
    <label>Coach ID
      <input id="coachId" type="text" placeholder="COACH_MDV_001">
    </label>
    <label>Swimmer ID
      <input id="swimmerId" type="text" placeholder="SWIMMER_001">
    </label>
    <div style="display:flex; gap:0.4rem; flex-wrap:wrap; margin-top:0.4rem;">
      <button id="btnSync">ðŸ”„ Ver informe</button>
      <button class="secondary" id="btnClear">ðŸ§¹ Limpiar</button>
    </div>
    <div id="msgConn" class="msg"></div>
  </section>

  <section class="card">
    <div style="display:flex; justify-content:space-between; gap:0.6rem; align-items:center; flex-wrap:wrap;">
      <h2 style="border:none; padding-bottom:0;"><span class="dot"></span> Informe</h2>
      <div id="meta" style="font-size:0.82rem; color:#4b5563;"></div>
    </div>
    <div class="summary" id="summary"></div>
    <div id="msgReport" class="msg"></div>
    <div class="table-wrap" id="tableWrap"></div>
  </section>

  <section class="card">
    <h2><span class="dot"></span> Cargar nueva marca</h2>
    <div class="inline" style="margin-bottom:0.4rem; font-size:0.82rem; color:#374151;">
      Permiso de ediciÃ³n: <strong id="permEdit">-</strong> Â· Permiso de borrado: <strong id="permDelete">-</strong>
    </div>
    <label>Fecha
      <input id="inpFecha" type="date">
    </label>
    <label>Estilo
      <input id="inpEstilo" type="text" placeholder="Libre / Pecho / Espalda">
    </label>
    <label>Distancia (m)
      <input id="inpDist" type="number" placeholder="50">
    </label>
    <label>Curso
      <select id="selCurso">
        <option value="LCM">LCM (50m)</option>
        <option value="SCM">SCM (25m)</option>
      </select>
    </label>
    <label>Tipo de toma
      <input id="inpTipo" type="text" placeholder="Oficial / Entrenamiento">
    </label>
    <label>Tiempo
      <input id="inpTiempo" type="text" placeholder="1:05.32">
    </label>
    <label>Evento / Lugar
      <input id="inpEvento" type="text" placeholder="Torneo provincial">
    </label>
    <div style="display:flex; gap:0.4rem; flex-wrap:wrap; margin-top:0.5rem;">
      <button id="btnAdd">âž• Agregar marca</button>
    </div>
    <div id="msgAdd" class="msg"></div>
  </section>
</main>
<script>
  const $ = id => document.getElementById(id);
  const LS_KEY = 'mdv_nadador_v9';
  let lastPerms = { allow_marks_edit:false, allow_marks_delete:false };

  function setMsg(id, text, cls='') { const el=$(id); if(!el) return; el.textContent=text||''; el.className='msg '+(cls||''); }
  function saveCfg(){ localStorage.setItem(LS_KEY, JSON.stringify({ webApp:$('webApp').value.trim(), coachId:$('coachId').value.trim(), swimmerId:$('swimmerId').value.trim() })); }
  function restoreCfg(){ try{const c=JSON.parse(localStorage.getItem(LS_KEY)||'{}'); if(c.webApp) $('webApp').value=c.webApp; if(c.coachId) $('coachId').value=c.coachId; if(c.swimmerId) $('swimmerId').value=c.swimmerId;}catch{} }

  function renderSummary(summary={}, perms={}){
    const box=$('summary');
    const pills=[];
    if(summary.total_marks!=null) pills.push(`<span class="pill">Marcas: ${summary.total_marks}</span>`);
    if(summary.last_mark_at) pills.push(`<span class="pill">Ãšltima: ${summary.last_mark_at}</span>`);
    pills.push(`<span class="pill">Editar: ${perms.allow_marks_edit?'sÃ­':'no'}</span>`);
    pills.push(`<span class="pill">Borrar: ${perms.allow_marks_delete?'sÃ­':'no'}</span>`);
    box.innerHTML=pills.join('');
    $('permEdit').textContent = perms.allow_marks_edit?'Permitido':'No';
    $('permDelete').textContent = perms.allow_marks_delete?'Permitido':'No';
    $('btnAdd').disabled = !perms.allow_marks_edit;
  }

  function renderTable(marks=[]) {
    const wrap=$('tableWrap');
    if(!marks.length){ wrap.innerHTML='<div class="msg">Sin marcas cargadas</div>'; return; }
    const rows = marks.map(m=>`<tr><td>${m.fecha||''}</td><td>${m.estilo||''}</td><td>${m.distancia_m||''}</td><td>${m.curso||''}</td><td>${m.tiempo_str||''}</td><td>${m.tipo_toma||''}</td><td>${m.lugar_evento||''}</td></tr>`).join('');
    wrap.innerHTML=`<table><thead><tr><th>Fecha</th><th>Estilo</th><th>Distancia</th><th>Curso</th><th>Tiempo</th><th>Tipo</th><th>Evento</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  async function sync() {
    const base=$('webApp').value.trim();
    const coach=$('coachId').value.trim();
    const swimmer=$('swimmerId').value.trim();
    if(!base||!coach||!swimmer){ setMsg('msgConn','Faltan datos de conexiÃ³n','error'); return; }
    saveCfg(); setMsg('msgConn','Cargando...'); setMsg('msgReport','');
    try{
      const res = await fetch(`${base}?action=get_swimmer_marks_with_context&coach_id=${encodeURIComponent(coach)}&swimmer_id=${encodeURIComponent(swimmer)}`);
      const data = await res.json();
      if(data.status!=='ok') throw new Error(data.error||'Error remoto');
      setMsg('msgConn','Informe listo','ok');
      $('meta').textContent = data.profile?.nombre || swimmer;
      lastPerms = data.permissions || { allow_marks_edit:false, allow_marks_delete:false };
      renderSummary(data.summary||{}, lastPerms);
      renderTable(data.marks||[]);
    }catch(err){ setMsg('msgConn','Error: '+err.message,'error'); }
  }

  async function addMark(){
    const base=$('webApp').value.trim();
    const coach=$('coachId').value.trim();
    const swimmer=$('swimmerId').value.trim();
    if(!lastPerms.allow_marks_edit){ setMsg('msgAdd','No tienes permiso para editar','error'); return; }
    const fecha=$('inpFecha').value;
    const estilo=$('inpEstilo').value;
    const dist=$('inpDist').value;
    const curso=$('selCurso').value;
    const tipo=$('inpTipo').value;
    const tiempo=$('inpTiempo').value;
    const evento=$('inpEvento').value;
    if(!fecha||!tiempo){ setMsg('msgAdd','Fecha y tiempo son obligatorios','error'); return; }
    setMsg('msgAdd','Enviando...');
    try{
      const params=new URLSearchParams({ action:'add_mark', coach_id:coach, swimmer_id:swimmer, actor_role:'swimmer', fecha, estilo, distancia_m:dist, curso, tipo_toma:tipo, tiempo_raw:tiempo, tiempo_str:tiempo, lugar_evento:evento });
      const res=await fetch(`${base}?${params.toString()}`,{ method:'POST' });
      const data=await res.json();
      if(data.status!=='ok') throw new Error(data.error||'No se pudo guardar');
      setMsg('msgAdd','Marca guardada','ok');
      sync();
    }catch(err){ setMsg('msgAdd','Error: '+err.message,'error'); }
  }

  function clearAll(){ ['webApp','coachId','swimmerId','inpFecha','inpEstilo','inpDist','inpTipo','inpTiempo','inpEvento'].forEach(id=>$(id).value=''); $('selCurso').value='LCM'; localStorage.removeItem(LS_KEY); lastPerms={allow_marks_edit:false, allow_marks_delete:false}; renderSummary({}, lastPerms); $('tableWrap').innerHTML=''; setMsg('msgConn',''); setMsg('msgReport',''); setMsg('msgAdd',''); }

  function init(){ restoreCfg(); $('btnSync').onclick=sync; $('btnAdd').onclick=addMark; $('btnClear').onclick=clearAll; }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
